<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Лична Призма – Блог</title>
  <meta name="description" content="Личен блог – публикации, теми, архив и автор." />
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <style>
    /* ==========================
       БАЗОВ СТИЛ + ТЕМА
       ========================== */
    :root{
      --bg: #ffffff;
      --surface: #f7f7f8;
      --ink: #1c1d20;
      --ink-muted:#5a5d66;
      --brand: #2b6cb0; /* синьо */
      --brand-ink: #174777;
      --accent: #e2e8f0; /* светло сиво */
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 22px;
    }

    /* Тъмен режим (по избор на системата) */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b0c0f;
        --surface: #121319;
        --ink: #f5f7fb;
        --ink-muted: #b1b5c3;
        --brand: #8ab4ff;
        --brand-ink:#2b6cb0;
        --accent: #1c1f2b;
        --border: #212432;
        --shadow: 0 8px 24px rgba(0,0,0,.35);
      }
      img{filter: brightness(.98) contrast(1.02)}
    }

    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      color: var(--ink);
      background: var(--bg);
    }
    a{ color: var(--brand); text-decoration: none; }
    a:hover{ text-decoration: underline; }
    h1,h2,h3,h4{ margin: 0 0 .35em; line-height:1.2 }
    h1{ font-size: clamp(1.6rem, 2vw + 1rem, 2.4rem); }
    h2{ font-size: clamp(1.25rem, 1.2vw + .9rem, 1.5rem); }
    p{ margin: .5em 0 1em; }
    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px;
    }

    /* ==========================
       ХЕДЪР
       ========================== */
    header.site-header{
      position: sticky; top: 0; z-index: 50;
      background: rgba(255,255,255,.8);
      backdrop-filter: saturate(140%) blur(10px);
      border-bottom: 1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      header.site-header{ background: rgba(15,16,22,.7) }
    }
    .site-header .bar{
      display:flex; align-items:center; gap: 16px;
      padding: 14px 0;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand-logo{ width:40px; height:40px; border-radius: 12px; background: linear-gradient(135deg, var(--brand), #7c3aed); box-shadow: var(--shadow); }
    .brand h1{ letter-spacing:.4px; }

    nav.primary-nav{ margin-left:auto; }
    nav.primary-nav ul{ list-style:none; margin:0; padding:0; display:flex; gap:14px; flex-wrap:wrap}
    nav.primary-nav a{ display:inline-block; padding:8px 12px; border-radius: 10px; }
    nav.primary-nav a:hover{ background: var(--accent); text-decoration:none }

    /* ==========================
       ЛАУТ – Лява колона + съдържание
       ========================== */
    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 22px;
      align-items: start;
      padding: 18px 0 36px;
    }
    @media (max-width: 960px){
      .layout{ grid-template-columns: 1fr; }
      aside.sidebar{ order: 2; }
    }

    aside.sidebar{
      position: sticky; top: 76px; /* под хедъра */
      max-height: calc(100dvh - 90px);
      overflow: auto;
      padding-right: 4px;
    }

    .card{ background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card + .card{ margin-top: 16px; }
    .card .card-h{ padding: 14px 16px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--brand-ink); }
    .card .card-c{ padding: 12px 16px; }

    .mini-post{
      display:grid; grid-template-columns: 72px 1fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px dashed var(--border);
    }
    .mini-post:last-child{ border-bottom:0 }
    .mini-post img{ width:72px; height:72px; object-fit:cover; border-radius: 10px; }
    .mini-title{ font-weight:600; }
    .meta{ color: var(--ink-muted); font-size:.9rem }

    .tag-cloud{ display:flex; flex-wrap:wrap; gap:8px }
    .tag{ padding:6px 10px; background:var(--accent); border-radius: 999px; font-size:.92rem; display:inline-flex; align-items:center; gap:6px }
    .tag .count{ font-size:.85em; color: var(--ink-muted) }

    .archive-list{ list-style:none; margin:0; padding:0; display:grid; gap:8px }
    .archive-list a{ display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:10px }
    .archive-list a:hover{ background:var(--accent); text-decoration:none }

    .author{
      display:grid; grid-template-columns: 64px 1fr; gap:12px; align-items:center;
    }
    .author img{ width:64px; height:64px; border-radius:14px; object-fit:cover; box-shadow: var(--shadow) }
    .author small{ color: var(--ink-muted) }

    /* ==========================
       ОСНОВНА СЕКЦИЯ
       ========================== */
    main#app{ display:grid; gap: 16px; }

    .post-card {
      display: flex;
      gap: 18px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .post-card .post-media-container {
      flex-shrink: 0;
      width: 220px;
      border-right: 1px solid var(--border);
    }
    .post-card .post-media {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .post-card .post-body {
      flex-grow: 1;
      padding: 14px 16px 14px 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .post-card .post-body h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .post-card .post-body p {
      margin-bottom: 0;
    }
    .post-card .post-actions {
      padding: 0;
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    @media (max-width: 640px) {
      .post-card {
        flex-direction: column;
        gap: 0;
      }
      .post-card .post-media-container {
        width: 100%;
        height: 180px;
        border-right: 0;
        border-bottom: 1px solid var(--border);
      }
       .post-card .post-body {
        padding: 14px 16px;
      }
    }

    .chip{ padding:6px 12px; border:1px solid var(--border); border-radius: 999px; font-size:.92rem; }
    
    .toggle-list-btn {
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--ink-muted);
        cursor: pointer;
        font-size: 0.9em;
        padding: 6px 12px;
        margin-top: 12px;
        width: 100%;
        text-align: center;
        transition: background .2s, border-color .2s;
    }
    .toggle-list-btn:hover {
        background: var(--accent);
        border-color: var(--brand);
    }

    .pagination{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding: 12px 0 0; border-top: 1px dashed var(--border); }
    .pagination .pages{ display:flex; gap:6px; flex-wrap:wrap }
    .pagination .pages span { padding: 6px 0; }
    .pagination a{ padding:6px 10px; border-radius: 8px; border:1px solid var(--border); }
    .pagination a[aria-current="page"]{ background: var(--brand); color:white; border-color: transparent; }

    /* Single view */
    article.single{ background: var(--surface); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .single .hero{ width:100%; aspect-ratio:16/9; object-fit:cover }
    .single .wrap{ padding: 16px; }
    .single .content img{ max-width:100%; border-radius:12px }
    .single .content figure{ margin: 0; }
    .single .content p{ text-wrap: pretty; }
    .back-link{ display:inline-block; margin-bottom: 8px }

    .comments{ margin-top: 22px; border-top:1px dashed var(--border); padding-top: 12px }
    .comment{ padding:10px 12px; border:1px solid var(--border); border-radius: 12px; background:var(--bg) }
    .comment + .comment{ margin-top: 10px }
    .comment small{ color: var(--ink-muted) }

    .muted{ color: var(--ink-muted) }
    .hidden{ display:none }

    /* Intro Section */
    .page-intro {
      text-align: center;
      padding: 24px 18px;
      border-bottom: 1px solid var(--border);
    }
    .page-intro h2 {
      font-size: 1.4rem;
      font-weight: 500;
      margin-bottom: .5em;
    }
    .page-intro p {
      max-width: 600px;
      margin: 0 auto 1.5em;
      color: var(--ink-muted);
    }
    .secondary-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 16px;
      font-size: .95rem;
    }
    .secondary-nav a {
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--accent);
      border: 1px solid transparent;
    }
    .secondary-nav a:hover {
      background: var(--bg);
      border-color: var(--border);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container bar">
      <a href="#" class="brand" data-link>
        <div class="brand-logo" aria-hidden="true"></div>
        <h1>Лична Призма</h1>
      </a>
      <nav class="primary-nav" aria-label="Основна навигация">
        <ul>
          <li><a href="#" data-link>Начало</a></li>
          <li><a href="#topics" data-link>Теми</a></li>
          <li><a href="#archive" data-link>Архив</a></li>
          <li><a href="#contact" data-link>Контакт</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="page-intro container">
    <h2>Лично творчество през призмата на собствената ми психология.</h2>
    <p>Обичам да пиша. В писанията си съм истинска и няма нужда да следвам ритъма на фалша и ежедневния театър.</p>
    <nav class="secondary-nav" aria-label="Допълнителна навигация">
      <a href="#view/contact" data-link>Контакти</a>
      <a href="#video-messages">Видео Послания</a>
      <a href="#zumba-steps">Zumba Стъпки</a>
      <a href="#one-more">Здраве с One More International</a>
      <a href="#books">Книги</a>
      <a href="#more">Още…</a>
    </nav>
  </section>

  <div class="container layout">
    <!-- Лявата вертикална секция -->
    <aside class="sidebar" id="sidebar">
      <!-- Някои публикации -->
      <section class="card" aria-labelledby="side-latest-h">
        <div class="card-h" id="side-latest-h">Публикации</div>
        <div class="card-c" id="side-latest"></div>
      </section>

      <!-- Теми -->
      <section class="card" aria-labelledby="topics-h">
        <div class="card-h" id="topics-h">Теми</div>
        <div class="card-c">
          <div class="tag-cloud" id="tag-cloud"></div>
        </div>
      </section>

      <!-- Архив -->
      <section class="card" aria-labelledby="archive-h">
        <div class="card-h" id="archive-h">Архив</div>
        <div class="card-c">
          <ul class="archive-list" id="archive-list"></ul>
        </div>
      </section>

      <!-- Автор -->
      <section class="card" aria-labelledby="author-h" id="author-card">
        <div class="card-h" id="author-h">За автора</div>
        <div class="card-c">
          <div class="author">
            <img src="https://picsum.photos/200?random=3" alt="Автор – профилна снимка" />
            <div>
              <strong>Автор: Stranded</strong><br />
              <small>I am a blogger, Zumba lover, wine admirer, mom, free-spirited, and a thinking woman.
                <a href="https://www.youtube.com/channel/UCkJwJyPNLu7zMseDETu7TJw" target="_blank" rel="noopener">YouTube</a>
              </small>           
            </div>
          </div>
        </div>
      </section>
    </aside>

    <!-- Основна секция -->
    <main id="app" aria-live="polite" aria-busy="false">
      <!-- Съдържанието се рендва динамично от JS (начален изглед: 5 най-нови) -->
    </main>
  </div>

  <script>
    /**
     * ==============================================
     * ГЛОБАЛНИ ПРОМЕНЛИВИ И КОНФИГУРАЦИЯ
     * ==============================================
     */
    const PAGE_SIZE = 5;
    let ALL_POSTS = []; // Глобален кеш за всички публикации

    const BLOGGER_URL = "https://www.lichna-prizma.eu/";  //"https://lichna-prizma.blogspot.com/";

    /**
     * ==============================================
     * ОСНОВНА ЛОГИКА
     * ==============================================
     */

    async function init() {
      document.getElementById('app').setAttribute('aria-busy', 'true');
      try {
        const { posts, author } = await fetchPosts();
        ALL_POSTS = posts.slice().sort((a, b) => b.date.localeCompare(a.date));
        renderSidebar(ALL_POSTS);
        renderAuthor(author);
        router();
      } catch (err) {
        console.error("Грешка при зареждане на публикациите:", err);
        document.getElementById('app').innerHTML = "<p>Възникна грешка при зареждане на съдържанието. Моля, опитайте по-късно.</p>";
      } finally {
        document.getElementById('app').setAttribute('aria-busy', 'false');
      }
    }

    async function fetchPosts() {
      const callbackName = 'jsonpCallback' + Date.now();
      const script = document.createElement('script');
      
      return new Promise((resolve, reject) => {
        window[callbackName] = (json) => {
          if (!json.feed || !json.feed.entry) {
            console.error("Грешен формат на JSON отговора", json);
            reject(new Error('Невалиден формат на данните от Blogger.'));
            return;
          }
          const posts = json.feed.entry.map(entry => {
            const id = entry.id.$t.split('.post-')[1];
            const linkObj = entry.link.find(l => l.rel === 'alternate');
            const url = linkObj ? linkObj.href : null;
            const coverMatch = entry.content && entry.content.$t ? entry.content.$t.match(/<img[^>]+src="([^">]+)"/) : null;
            const cover = entry.media$thumbnail ? entry.media$thumbnail.url : (coverMatch ? coverMatch[1] : null);

            return {
              id: id,
              title: entry.title.$t,
              date: entry.published.$t.slice(0, 10),
              tags: (entry.category || []).map(c => c.term),
              html: entry.content ? DOMPurify.sanitize(entry.content.$t) : '',
              cover: cover,
              excerpt: toExcerpt(entry.content?.$t, 150),
              url: url
            };
          });
          
          const author = {
              name: json.feed.author[0].name.$t,
              avatar: json.feed.author[0].gd$image.src
          };

          resolve({ posts, author });

          delete window[callbackName];
          document.head.removeChild(script);
        };

        script.src = `${BLOGGER_URL}/feeds/posts/default?alt=json-in-script&callback=${callbackName}&max-results=500`;
        script.onerror = () => {
            reject(new Error('Неуспешно зареждане на скрипта за публикации.'));
            delete window[callbackName];
            document.head.removeChild(script);
        };
        
        document.head.appendChild(script);
      });
    }

    /**
     * ==============================================
     * РЕНДЪР ФУНКЦИИ (UI)
     * ==============================================
     */

    const fmtDate = (iso) => new Date(iso).toLocaleDateString('bg-BG', { day: '2-digit', month: 'long', year: 'numeric' });

    function toExcerpt(html, max = 180) {
      if (!html) return '';
      const text = html.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
      return text.length > max ? text.slice(0, max - 1).trim() + '…' : text;
    }

    function computeTaxonomies(posts) {
      const tags = new Map();
      const archive = new Map();
      for (const p of posts) {
        (p.tags || []).forEach(t => tags.set(t, (tags.get(t) || 0) + 1));
        const ym = p.date.slice(0, 7);
        archive.set(ym, (archive.get(ym) || 0) + 1);
      }
      return {
        tags: [...tags.entries()].sort((a, b) => b[1] - a[1]),
        archive: [...archive.entries()].sort((a, b) => b[0].localeCompare(a[0]))
      };
    }

    function renderSidebar(posts) {
        const SIDE_POST_LIMIT = 6;
        const TAG_LIMIT = 5;
        const ARCHIVE_LIMIT = 5;

        const side = document.getElementById('side-latest');
        if (side) {
            side.innerHTML = posts.slice(0, SIDE_POST_LIMIT).map(p => {
                const imageUrl = p.cover ? p.cover.replace(/\/s\d+(-c)?\//, '/s72-c/') : 'https://picsum.photos/72?grayscale';
                return `
                <article class="mini-post">
                  <a href="#post/${p.id}" data-link>
                    <img src="${imageUrl}" alt="${escapeHtml(p.title)}" loading="lazy" />
                  </a>
                  <div>
                    <a class="mini-title" href="#post/${p.id}" data-link>${escapeHtml(p.title)}</a>
                    <div class="meta">${fmtDate(p.date)}</div>
                  </div>
                </article>
              `
            }).join('');
        }

        const { tags, archive } = computeTaxonomies(posts);

        const tcloud = document.getElementById('tag-cloud');
        if (tcloud) {
            const tagRenderer = ([t, c], index) => {
                const isHidden = index >= TAG_LIMIT;
                return `<a class="tag sidebar-item ${isHidden ? 'hidden-item' : ''}" href="#tag/${encodeURIComponent(t)}" data-link style="${isHidden ? 'display:none;' : ''}">${escapeHtml(t)} <span class="count">(${c})</span></a>`;
            };
            let tagsHtml = tags.map(tagRenderer).join('');
            if (tags.length > TAG_LIMIT) {
                tagsHtml += `<button class="toggle-list-btn" data-target-selector=".sidebar-item.hidden-item" data-container="tag-cloud" data-total="${tags.length}" data-show-text="Покажи всички" data-hide-text="Покажи по-малко">Покажи всички (${tags.length})</button>`;
            }
            tcloud.innerHTML = tagsHtml;
        }

        const alist = document.getElementById('archive-list');
        if (alist) {
            const archiveRenderer = ([ym, c], index) => {
                const d = new Date(`${ym}-01T12:00:00Z`);
                const label = d.toLocaleDateString('bg-BG', { month: 'long', year: 'numeric' });
                const isHidden = index >= ARCHIVE_LIMIT;
                return `<li class="archive-item ${isHidden ? 'hidden-item' : ''}" style="${isHidden ? 'display:none;' : ''}"><a href="#archive/${ym}" data-link><span>${label}</span><span class="muted">${c}</span></a></li>`;
            };
            let archiveHtml = archive.map(archiveRenderer).join('');
            if (archive.length > ARCHIVE_LIMIT) {
                archiveHtml += `<li><button class="toggle-list-btn" data-target-selector=".archive-item.hidden-item" data-container="archive-list" data-total="${archive.length}" data-show-text="Покажи всички" data-hide-text="Покажи по-малко">Покажи всички (${archive.length})</button></li>`;
            }
            alist.innerHTML = archiveHtml;
        }
    }
    
    function renderAuthor(author) {
        const authorCard = document.getElementById('author-card');
        if (!authorCard || !author) return;

        const img = authorCard.querySelector('.author img');
        const nameEl = authorCard.querySelector('.author strong');

        if (img && author.avatar) {
            // Зареждаме по-голяма снимка, ако е налична
            img.src = author.avatar.replace(/\/s\d+(-c)?\//, '/s128-c/');
            img.alt = `Автор – ${author.name}`;
        }
        if (nameEl && author.name) {
            nameEl.textContent = `Автор: ${author.name}`;
        }
    }

    function renderHome(page = 1, list = ALL_POSTS) {
      const app = document.getElementById('app');
      const start = (page - 1) * PAGE_SIZE;
      const slice = list.slice(start, start + PAGE_SIZE);
      
      const baseRoute = list === ALL_POSTS ? '#page' : location.hash.split('/').slice(0, 2).join('/');

      app.innerHTML = slice.map(p => {
        const imageUrl = p.cover ? p.cover.replace(/\/s\d+(-c)?\//, '/s400/') : '';
        return `
        <article class="post-card">
          ${p.cover ? `
            <div class="post-media-container">
              <a href="#post/${p.id}" data-link>
                <img class="post-media" src="${imageUrl}" alt="${escapeHtml(p.title)}" loading="lazy" />
              </a>
            </div>
          ` : ''}
          <div class="post-body">
            <div>
              <h2><a href="#post/${p.id}" data-link>${escapeHtml(p.title)}</a></h2>
              <div class="meta">${fmtDate(p.date)}</div>
              <p>${p.excerpt}</p>
            </div>
            <div class="post-actions">
              <div class="meta">
                ${(p.tags || []).map(t => `<a href="#tag/${encodeURIComponent(t)}" data-link class="chip">${escapeHtml(t)}</a>`).join(' ')}
              </div>
              <a class="chip" href="#post/${p.id}" data-link>Прочети →</a>
            </div>
          </div>
        </article>
      `}).join('') + renderPagination(page, Math.ceil(list.length / PAGE_SIZE), baseRoute);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function renderPagination(page, pages, baseRoute = '#page') {
        if (pages <= 1) return '';

        const prev = page > 1 ? `<a href="${baseRoute}/${page - 1}" data-link>← Предишни</a>` : '<span></span>';
        const next = page < pages ? `<a href="${baseRoute}/${page + 1}" data-link>Следващи →</a>` : '<span></span>';

        const maxVisibleButtons = 7;
        let pageNumbers = [];

        if (pages <= maxVisibleButtons) {
            for (let i = 1; i <= pages; i++) {
                pageNumbers.push(i);
            }
        } else {
            pageNumbers.push(1);
            let start = Math.max(2, page - 2);
            let end = Math.min(pages - 1, page + 2);

            if (page <= 4) {
                start = 2;
                end = 5;
            }

            if (page >= pages - 3) {
                start = pages - 4;
                end = pages - 1;
            }

            if (start > 2) {
                pageNumbers.push('...');
            }

            for (let i = start; i <= end; i++) {
                pageNumbers.push(i);
            }

            if (end < pages - 1) {
                pageNumbers.push('...');
            }

            pageNumbers.push(pages);
        }

        const nums = pageNumbers.map(num => {
            if (num === '...') {
                return `<span class="muted">...</span>`;
            }
            return `<a href="${baseRoute}/${num}" data-link ${num === page ? 'aria-current="page"' : ''}>${num}</a>`;
        }).join('');

        return `<nav class="pagination" aria-label="Навигация между страници">
            ${prev}
            <div class="pages">${nums}</div>
            ${next}
        </nav>`;
    }

    function renderPost(id) {
      const app = document.getElementById('app');
      const p = ALL_POSTS.find(x=> String(x.id) === String(id));
      if(!p){ app.innerHTML = `<p>Статията не е намерена.</p>`; return; }
      const imageUrl = p.cover ? p.cover.replace(/\/s\d+(-c)?\//, '/s1600/') : '';

      app.innerHTML = `
        <article class="single">
          ${p.cover ? `<img class="hero" src="${imageUrl}" alt="${escapeHtml(p.title)}" />` : ''}
          <div class="wrap">
            <a class="back-link" href="#" data-link>← Към началото</a>
            <h1>${escapeHtml(p.title)}</h1>
            <div class="meta">Публикувано: ${fmtDate(p.date)} · Теми: ${(p.tags||[]).map(t=>`<a href="#tag/${encodeURIComponent(t)}" data-link>${escapeHtml(t)}</a>`).join(', ') || '—'}</div>
            <div class="content">${p.html}</div>
            <div class="post-actions" style="padding-left:0">
              ${shareButtons(p)}
            </div>
            <section class="comments" aria-labelledby="comments-h">
              <h3 id="comments-h">Коментари</h3>
              <div id="comments-list"></div>
            </section>
          </div>
        </article>
      `;
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function renderByTag(tag, page = 1) {
      const list = ALL_POSTS.filter(p => (p.tags || []).map(t => t.toLowerCase()).includes(tag.toLowerCase()));
      const app = document.getElementById('app');
      if (list.length === 0) {
        app.innerHTML = `<p>Няма публикации с тема „${escapeHtml(tag)}“.</p>`;
        return;
      }
      app.innerHTML = `<h2>Тема: ${escapeHtml(tag)}</h2>`;
      renderHome(page, list);
    }

    function renderArchive(ym, page = 1) {
      const list = ALL_POSTS.filter(p => p.date.startsWith(ym));
      const d = new Date(ym + '-01T12:00:00Z');
      const label = d.toLocaleDateString('bg-BG', { month: 'long', year: 'numeric' });
      const app = document.getElementById('app');
      app.innerHTML = `<h2>Архив: ${label}</h2>`;
      renderHome(page, list);
    }

    function renderStaticPage(pageName) {
        const app = document.getElementById('app');
        app.innerHTML = `<p>Зареждане...</p>`;

        // Карта на имената на страниците към техните пътища в Blogger
        const pagePaths = {
            'contact': '/p/blog-page.html'
        };

        const path = pagePaths[pageName];
        if (!path) {
            app.innerHTML = `<p>Страницата не е намерена.</p>`;
            return;
        }

        const callbackName = 'jsonpPageCallback' + Date.now();
        const script = document.createElement('script');

        window[callbackName] = (json) => {
            if (!json.feed || !json.feed.entry || json.feed.entry.length === 0) {
                console.error("Грешен формат на JSON отговора за страница", json);
                app.innerHTML = `<p>Възникна грешка при зареждане на съдържанието или страницата е празна.</p>`;
                delete window[callbackName];
                document.head.removeChild(script);
                return;
            }

            const page = json.feed.entry[0]; // Взимаме първия резултат
            const title = page.title.$t;
            const content = page.content ? DOMPurify.sanitize(page.content.$t) : '';

            app.innerHTML = `
                <article class="single">
                  <div class="wrap">
                    <h1>${escapeHtml(title)}</h1>
                    <div class="content">${content}</div>
                  </div>
                </article>
            `;
            window.scrollTo({top:0, behavior:'smooth'});

            delete window[callbackName];
            document.head.removeChild(script);
        };

        script.src = `${BLOGGER_URL}/feeds/pages/default?path=${path}&alt=json-in-script&callback=${callbackName}`;
        script.onerror = () => {
            app.innerHTML = `<p>Възникна грешка при зареждане на съдържанието.</p>`;
            delete window[callbackName];
            document.head.removeChild(script);
        };

        document.head.appendChild(script);
    }

    /**
     * ==============================================
     * ПОМОЩНИ ФУНКЦИИ И МАРШРУТИЗАЦИЯ
     * ==============================================
     */

    function router() {
      const h = location.hash.replace(/^#/, '');
      document.getElementById('app').setAttribute('aria-busy', 'true');

      if (!h || h === 'topics' || h === 'archive' || h === 'contact') {
        renderHome(1, ALL_POSTS);
      } else if (h.startsWith('post/')) {
        const id = h.split('/')[1];
        renderPost(id);
      } else if (h.startsWith('page/')) {
        const n = Math.max(1, parseInt(h.split('/')[1] || '1', 10));
        renderHome(n, ALL_POSTS);
      } else if (h.startsWith('view/')) {
        const pageName = h.split('/')[1];
        renderStaticPage(pageName);
      } else if (h.startsWith('tag/')) {
        const parts = h.split('/');
        const tag = decodeURIComponent(parts[1]);
        const page = Math.max(1, parseInt(parts[2] || '1', 10));
        renderByTag(tag, page);
      } else if (h.startsWith('archive/')) {
        const parts = h.split('/');
        const ym = parts[1];
        const page = Math.max(1, parseInt(parts[2] || '1', 10));
        renderArchive(ym, page);
      } else {
        renderHome(1, ALL_POSTS);
      }
      document.getElementById('app').setAttribute('aria-busy', 'false');
    }

    function shareButtons(p) {
      const url = p.url || (location.origin + location.pathname + `#post/${p.id}`);
      const title = encodeURIComponent(p.title);
      const u = encodeURIComponent(url);
      const fb = `https://www.facebook.com/sharer/sharer.php?u=${u}`;
      const x = `https://twitter.com/intent/tweet?url=${u}&text=${title}`;
      const mail = `mailto:?subject=${title}&body=${u}`;
      return `
        <button class="chip" onclick="shareNative('${escapeQuotes(p.title)}','${escapeQuotes(url)}')">Сподели</button>
        <a class="chip" href="${fb}" target="_blank" rel="noopener">Facebook</a>
        <a class="chip" href="${x}" target="_blank" rel="noopener">X/Twitter</a>
        <a class="chip" href="${mail}">Имейл</a>`;
    }

    async function shareNative(title, url) {
      try {
        if (navigator.share) {
          await navigator.share({ title, url });
        } else {
          alert('Функцията за споделяне не се поддържа от този браузър. Моля, използвайте бутоните за социални мрежи.');
        }
      } catch (e) { /* Потребителят е отказал споделянето */ }
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>()"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '(': '&#40;', ')': '&#41;', '"': '&quot;', "'": '&#39;' }[m]));
    }
    function escapeQuotes(s) {
        if (!s) return '';
        return String(s).replace(/["']/g, m => ({'"':'&quot;',"'":'&#39;'}[m]));
    }

    document.addEventListener('DOMContentLoaded', () => {
      init();
      window.addEventListener('hashchange', router);
      
      document.getElementById('sidebar').addEventListener('click', e => {
          if (e.target.classList.contains('toggle-list-btn')) {
              const btn = e.target;
              const containerId = btn.dataset.container;
              const container = document.getElementById(containerId);
              const targetSelector = btn.dataset.targetSelector;

              if (container && targetSelector) {
                  const itemsToToggle = container.querySelectorAll(targetSelector);
                  let isNowVisible;

                  itemsToToggle.forEach(item => {
                      const isHidden = item.style.display === 'none';
                      item.style.display = isHidden ? '' : 'none';
                      if (isNowVisible === undefined) {
                          isNowVisible = isHidden;
                      }
                  });

                  if (isNowVisible !== undefined) {
                      btn.textContent = isNowVisible
                          ? btn.dataset.hideText
                          : `${btn.dataset.showText} (${btn.dataset.total})`;
                  }
              }
          }
      });

      document.body.addEventListener('click', e => {
        const link = e.target.closest('a[data-link]');
        if (link) {
          e.preventDefault();
          const href = link.getAttribute('href');
          if(location.hash !== href) {
            location.hash = href;
          }
        }
      });
    });
  </script>
</body>
</html>
